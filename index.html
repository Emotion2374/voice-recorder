<script>
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const player   = document.getElementById('player');
  const download = document.getElementById('download');
  const redoBtn  = document.getElementById('redo');
  const statusEl = document.getElementById('status');

  let mediaRecorder, chunks = [], startT = 0, blob = null, chosenType = '', fileExt = 'webm';

  // Prefer formats by platform: iOS → m4a (AAC); others → webm (Opus)
  const candidates = [
    { type: 'audio/mp4;codecs=mp4a.40.2', ext: 'm4a' }, // iOS Safari friendly
    { type: 'audio/mp4',                  ext: 'm4a' },
    { type: 'audio/webm;codecs=opus',     ext: 'webm' }, // Chrome/Android
    { type: 'audio/webm',                 ext: 'webm' },
    { type: '',                           ext: 'webm' }  // let browser pick default
  ];

  function pickMime() {
    for (const c of candidates) {
      try {
        if (!c.type || MediaRecorder.isTypeSupported(c.type)) {
          chosenType = c.type;
          fileExt = c.ext;
          return;
        }
      } catch (e) {}
    }
  }
  pickMime();

  async function getMic() {
    // Must be HTTPS and triggered by a user gesture
    return navigator.mediaDevices.getUserMedia({ audio: true });
  }

  // Hide player until we have audio (prevents “Error” banner)
  player.style.display = 'none';

  startBtn.onclick = async () => {
    try {
      const stream = await getMic();
      chunks = [];
      const opts = chosenType ? { mimeType: chosenType } : {};
      mediaRecorder = new MediaRecorder(stream, opts);

      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };

      mediaRecorder.onstart = () => {
        startT = Date.now();
        statusEl.textContent = 'Recording…';
        startBtn.disabled = true;
        stopBtn.disabled = false;
        download.style.display = 'none';
        redoBtn.style.display = 'none';
        player.src = '';
        player.style.display = 'none';
        blob = null;
      };

      mediaRecorder.onstop = () => {
        const dur = ((Date.now() - startT) / 1000).toFixed(1);
        const mime = chosenType || 'audio/mp4';
        blob = new Blob(chunks, { type: mime });
        const url = URL.createObjectURL(blob);

        player.src = url;
        player.style.display = 'block'; // only show now
        download.href = url;
        download.download = `response.${fileExt}`;
        download.style.display = 'inline-block';

        redoBtn.style.display = 'inline-block';
        statusEl.textContent = `Recorded ${dur}s. Download, then upload in the survey below.`;
        stopBtn.disabled = true;
      };

      mediaRecorder.start();
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Microphone access failed. Open in Safari/Chrome and allow mic.';
    }
  };

  stopBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  };

  redoBtn.onclick = () => {
    startBtn.disabled = false;
    download.style.display = 'none';
    redoBtn.style.display = 'none';
    player.src = '';
    player.style.display = 'none';
    statusEl.textContent = 'Ready.';
  };
</script>

