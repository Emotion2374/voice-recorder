<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voice Recorder</title>
<style>
  :root { --pad: 14px; }
  body { font-family: system-ui, Arial, sans-serif; margin: var(--pad); }
  h2 { margin: 0 0 8px; }
  .row { margin: 10px 0; }
  button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; cursor: pointer; }
  #status { font-size: .95rem; color: #333; }
</style>
</head>
<body>
  <h2>Record your answer</h2>
  <div class="row">
    <button id="start">üéôÔ∏è Start</button>
    <button id="stop" disabled>‚èπÔ∏è Stop</button>
  </div>
  <div class="row">
    <audio id="player" controls></audio>
  </div>
  <div class="row">
    <a id="download" href="#" download="response.webm" style="display:none">
      ‚¨áÔ∏è Download your recording
    </a>
    <button id="redo" style="display:none">‚Ü∫ Record again</button>
  </div>
  <div id="status" class="row">Ready.</div>

  <script>
    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');
    const player   = document.getElementById('player');
    const download = document.getElementById('download');
    const redoBtn  = document.getElementById('redo');
    const statusEl = document.getElementById('status');

    let mediaRecorder, chunks = [], startT = 0, blob = null;

    async function getMic() {
      // HTTPS + user gesture required (works on iOS/Android/desktop)
      return navigator.mediaDevices.getUserMedia({ audio: true });
    }

    startBtn.onclick = async () => {
      try {
        const stream = await getMic();
        chunks = [];
        const options = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? { mimeType: 'audio/webm;codecs=opus' }
          : {};
        mediaRecorder = new MediaRecorder(stream, options);
        mediaRecorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
        mediaRecorder.onstart = () => {
          startT = Date.now();
          statusEl.textContent = 'Recording‚Ä¶';
          startBtn.disabled = true;
          stopBtn.disabled = false;
          download.style.display = 'none';
          redoBtn.style.display = 'none';
          player.src = '';
          blob = null;
        };
        mediaRecorder.onstop = () => {
          const dur = ((Date.now() - startT) / 1000).toFixed(1);
          blob = new Blob(chunks, { type: 'audio/webm' });
          player.src = URL.createObjectURL(blob);
          const fileUrl = URL.createObjectURL(blob);
          download.href = fileUrl;
          download.style.display = 'inline-block';
          redoBtn.style.display = 'inline-block';
          statusEl.textContent = `Recorded ${dur}s. Tap ‚ÄúDownload‚Äù, then upload the saved file below.`;
          stopBtn.disabled = true;
        };
        mediaRecorder.start();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Microphone access failed. Please allow mic permission.';
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    };

    redoBtn.onclick = () => {
      startBtn.disabled = false;
      download.style.display = 'none';
      redoBtn.style.display = 'none';
      player.src = '';
      statusEl.textContent = 'Ready.';
    };
  </script>
</body>
</html>
